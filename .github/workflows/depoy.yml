name: Build & Deploy Placfy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Node.js 22
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4️⃣ Build Vite React app with hardcoded env variables
      - name: Build React app
        env:
          VITE_API_URL: "https://conservation-dpi-studied-certainly.trycloudflare.com/api"
          VITE_GOOGLE_CLIENT_ID: "250754744117-f8u8s28jbfj6jjts8rcm28s0a3cokgv1.apps.googleusercontent.com"
        run: npm run build

      # 5️⃣ Start SSH agent with your deploy key
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 6️⃣ Deploy dist folder + optional .env to VPS
      - name: Deploy to VPS
        run: |
          # Ensure target dir exists and remove old files
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "mkdir -p ${{ secrets.VPS_PATH }} && rm -rf ${{ secrets.VPS_PATH }}/*"

          # Copy Vite output (dist) to VPS
          scp -o StrictHostKeyChecking=no -r dist/* ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH }}/

          # Copy .env if present
          scp -o StrictHostKeyChecking=no .env ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH }}/ || echo ".env not found, skipping"
